import PDFDocument from 'pdfkit';
import fs from 'fs';

export function generatePdfReport({ nome, numero, progresso = [], caminho }) {
  try {
    const doc = new PDFDocument({ margin: 50 });
    doc.pipe(fs.createWriteStream(caminho));

    // Cabe√ßalho
    doc.fontSize(20)
      .text('üìö Relat√≥rio Semanal - Professora Lumi üíú', { align: 'center' })
      .moveDown();

    // Informa√ß√µes b√°sicas
    doc.fontSize(14)
      .text(`Aluno(a): ${nome || 'N√£o informado'}`)
      .text(`N√∫mero: ${numero || 'N√£o informado'}`)
      .moveDown();

    // N√≠vel e estrelas
    const estrelas = progresso.filter(p => p.acertou).length;
    const nivel = Math.floor(estrelas / 5) + 1;
    doc.fontSize(16).text(`üåü N√≠vel atual: ${nivel} (${estrelas} estrelas acumuladas)`);

    // Estilo de aprendizagem dominante
    const estilos = { visual: 0, auditivo: 0, narrativo: 0, cinestesico: 0 };
    progresso.forEach(p => {
      if (p.acertou && p.tipoDesafio && estilos[p.tipoDesafio] !== undefined) {
        estilos[p.tipoDesafio]++;
      }
    });
    const estiloDominante = Object.entries(estilos).sort((a, b) => b[1] - a[1])[0]?.[0];
    const estiloTexto = estiloDominante
      ? `üß† Estilo de aprendizagem mais forte: ${estiloDominante}`
      : 'üß† Estilo de aprendizagem ainda em an√°lise';
    doc.moveDown().fontSize(14).text(estiloTexto);

    doc.moveDown().fontSize(16).text('üìä Desempenho nos desafios:', { underline: true }).moveDown(0.5);

    if (progresso.length === 0) {
      doc.fontSize(12).text('Nenhum desafio registrado nesta semana.');
    } else {
      progresso.forEach((item, i) => {
        const categoria = item.categoria || 'Indefinida';
        const resultado = item.acertou ? '‚úÖ Acertou' : '‚ùå Errou';
        doc.fontSize(12).text(`${i + 1}. Categoria: ${categoria} | Resultado: ${resultado}`);
      });
    }

    doc.moveDown(2);
    doc.fontSize(12).text(
      'Continue incentivando o aprendizado com carinho e curiosidade! At√© a pr√≥xima semana. ‚ú®',
      { align: 'center' }
    );

    doc.end();
  } catch (error) {
    console.error('‚ùå Erro ao gerar PDF:', error);
    throw error;
  }
}
