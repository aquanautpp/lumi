import PDFDocument from 'pdfkit';
import fs from 'fs';

export function generatePdfReport({ nome, numero, progresso, caminho }) {
  const doc = new PDFDocument();

  doc.pipe(fs.createWriteStream(caminho));

  // Cabe√ßalho
  doc
    .fontSize(20)
    .text('üìò Relat√≥rio de Progresso - Professora Lumi üíú', { align: 'center' })
    .moveDown();

  doc
    .fontSize(14)
    .text(`üë§ Aluno: ${nome}`)
    .text(`üì± N√∫mero: ${numero}`)
    .moveDown();

  const totalEstrelas = progresso.filter(p => p.acertou).length;
  const nivel = definirNivel(totalEstrelas);

  doc
    .fontSize(14)
    .text(`‚≠ê Estrelas acumuladas: ${totalEstrelas}`)
    .text(`üèÜ N√≠vel: ${nivel}`)
    .moveDown();

  // Hist√≥rico
  doc
    .fontSize(16)
    .text('üìä Hist√≥rico de Desafios', { underline: true })
    .moveDown(0.5);

  if (progresso.length === 0) {
    doc.fontSize(12).text('Nenhum desafio registrado ainda.');
  } else {
    progresso.slice(-10).reverse().forEach((item, index) => {
      const data = new Date(item.data).toLocaleString('pt-BR');
      const resultado = item.acertou ? '‚úÖ Acertou' : '‚ùå Errou';
      const estilo = item.tipoDesafio ? ` (${item.tipoDesafio})` : '';
      doc
        .fontSize(12)
        .text(`${index + 1}. [${data}] ${resultado} - ${item.categoria}${estilo}`);
    });
  }

  doc.end();
}

function definirNivel(estrelas) {
  if (estrelas < 5) return 'Iniciante ‚≠ê';
  if (estrelas < 10) return 'Explorador üîç';
  if (estrelas < 15) return 'Desafiante üí•';
  return 'Mestre Lumi üß†';
}
